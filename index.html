<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Task List</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic appeal and responsiveness */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        .task-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Custom scrollbar for task list */
        #taskList::-webkit-scrollbar {
            width: 6px;
        }
        #taskList::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* Slate 400 */
            border-radius: 3px;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex flex-col items-center">

    <div class="w-full max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Team Task Board</h1>
            <p class="text-gray-500">Real-time task synchronization for all users.</p>
            <div id="userInfo" class="mt-2 text-xs text-blue-600 font-medium p-1 bg-blue-100 rounded-full inline-block px-3">
                Loading User...
            </div>
        </header>

        <!-- New Task Input Section -->
        <div class="task-card bg-white p-5 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">Add New Task</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="taskInput" placeholder="Enter new task description..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                <button id="addTaskBtn"
                        class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-150 active:scale-95 disabled:bg-blue-300">
                    Add Task
                </button>
            </div>
            <div id="messageBox" class="text-sm mt-3 text-red-500 hidden"></div>
        </div>

        <!-- Task List Display -->
        <div class="task-card bg-white p-5 rounded-xl">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Pending Tasks</h2>
            <div id="taskList" class="space-y-3 overflow-y-auto max-h-[60vh]">
                <!-- Tasks will be rendered here by JavaScript -->
                <p id="loadingMessage" class="text-center text-gray-400">Loading tasks...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;

        const taskInput = document.getElementById('taskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskList = document.getElementById('taskList');
        const messageBox = document.getElementById('messageBox');
        const userInfo = document.getElementById('userInfo');

        // Function to display messages (instead of alert)
        const showMessage = (msg, type = 'error') => {
            messageBox.textContent = msg;
            messageBox.className = `text-sm mt-3 p-2 rounded-lg ${type === 'error' ? 'text-red-700 bg-red-100' : 'text-green-700 bg-green-100'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        };

        // --- Firebase Initialization and Authentication ---
        const initializeFirebase = async () => {
            try {
                // setLogLevel('Debug'); // Uncomment for debugging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Handle authentication status
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfo.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        console.log('User authenticated:', userId);
                        // Start listening to tasks only after authentication is ready
                        setupTaskListener();
                    } else {
                        // Attempt to authenticate
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage(`Failed to initialize app: ${error.message}`, 'error');
            }
        };

        // --- Firestore Operations ---

        // Firestore data path (Public data for collaboration)
        const getTasksCollectionRef = () => {
            if (!db || !userId) return null;
            // Public path: /artifacts/{appId}/public/data/tasks
            const collectionPath = `artifacts/${appId}/public/data/tasks`;
            return collection(db, collectionPath);
        };

        const setupTaskListener = () => {
            const tasksRef = getTasksCollectionRef();
            if (!tasksRef) return;

            // Note: We avoid orderBy() to prevent index creation errors, and sort locally.
            const q = query(tasksRef);

            // Real-time listener for task changes
            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });

                // Sort locally by creation date (newest first)
                tasks.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                renderTasks(tasks);
            }, (error) => {
                console.error("Error listening to tasks:", error);
                showMessage("Could not load tasks in real-time.", 'error');
            });
        };

        const addTask = async (description) => {
            if (!isAuthReady || !db) return showMessage("App not ready. Please wait.", 'error');

            const tasksRef = getTasksCollectionRef();
            if (!tasksRef) return showMessage("Firestore connection failed.", 'error');

            try {
                // **Simulated Fix:** The data object below has correct comma separation.
                // If there was an error like "task: description assignedBy: userId",
                // 'assignedBy' would be the 'Unexpected identifier'.
                await addDoc(tasksRef, {
                    task: description,
                    isComplete: false,
                    assignedBy: userId, // Correctly placed after a comma
                    createdAt: serverTimestamp()
                });
                taskInput.value = '';
                showMessage("Task added successfully!", 'success');
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage(`Error adding task: ${error.message}`, 'error');
            }
        };

        const toggleTaskComplete = async (taskId, isComplete) => {
            if (!isAuthReady || !db) return;
            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            try {
                await updateDoc(docRef, {
                    isComplete: !isComplete
                });
            } catch (error) {
                console.error("Error updating document: ", error);
                showMessage(`Error updating task: ${error.message}`, 'error');
            }
        };

        const deleteTask = async (taskId) => {
            if (!isAuthReady || !db) return;
            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            try {
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
                showMessage(`Error deleting task: ${error.message}`, 'error');
            }
        };

        // --- UI Rendering and Event Handlers ---

        const renderTasks = (tasks) => {
            taskList.innerHTML = '';
            document.getElementById('loadingMessage')?.remove();

            if (tasks.length === 0) {
                taskList.innerHTML = '<p class="text-center text-gray-500 p-4 border border-dashed rounded-lg bg-gray-50">No tasks on the board. Add one!</p>';
                return;
            }

            tasks.forEach(task => {
                const taskItem = document.createElement('div');
                const isCompleted = task.isComplete;
                const completedClass = isCompleted ? 'bg-green-50 border-green-300' : 'bg-white hover:bg-gray-50 border-gray-200';
                const textClass = isCompleted ? 'line-through text-gray-400' : 'text-gray-800';

                taskItem.className = `flex items-start justify-between p-4 rounded-lg border-2 transition duration-150 ${completedClass}`;
                taskItem.innerHTML = `
                    <div class="flex-grow min-w-0 mr-4">
                        <p class="font-medium text-lg break-words ${textClass}">${task.task}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            Added by: <span class="font-mono text-xs">${task.assignedBy.substring(0, 8)}...</span>
                            ${task.createdAt ? ' | ' + new Date(task.createdAt.seconds * 1000).toLocaleDateString() : ''}
                        </p>
                    </div>
                    <div class="flex space-x-2 flex-shrink-0">
                        <button data-id="${task.id}" data-complete="${isCompleted}" class="toggle-btn p-2 rounded-full transition duration-150 ${isCompleted ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-yellow-500 hover:bg-yellow-600 text-white'}" title="${isCompleted ? 'Mark Pending' : 'Mark Complete'}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                ${isCompleted ? '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 14.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />' : '<path d="M5 3v4M3 5h4M17 13v4m-4 0h4M8 15h3m-3 0h.01M5 12h2l3 3 5-5m1-2a2 2 0 11-4 0 2 2 0 014 0zM12 9a2 2 0 100-4 2 2 0 000 4z" />'}
                            </svg>
                        </button>
                        <button data-id="${task.id}" class="delete-btn p-2 rounded-full bg-red-500 hover:bg-red-600 text-white transition duration-150" title="Delete Task">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                taskList.appendChild(taskItem);
            });

            // Re-attach event listeners after rendering
            document.querySelectorAll('.toggle-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const isComplete = e.currentTarget.dataset.complete === 'true';
                    toggleTaskComplete(id, isComplete);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    deleteTask(e.currentTarget.dataset.id);
                });
            });
        };

        // Initialize on window load
        window.onload = () => {
            initializeFirebase();

            addTaskBtn.addEventListener('click', () => {
                const task = taskInput.value.trim();
                if (task) {
                    addTask(task);
                } else {
                    showMessage("Task description cannot be empty.", 'error');
                }
            });

            taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTaskBtn.click();
                }
            });
        };
    </script>
</body>
</html>
